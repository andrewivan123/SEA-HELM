#!/bin/bash
#PBS -P CFP01-CF-060
#PBS -j oe
#PBS -k oed
#PBS -q auto
#PBS -l select=1:ngpus=4
#PBS -l walltime=56:00:00

cd $PBS_O_WORKDIR

image="/app1/common/singularity-img/hopper/cuda/cuda_12.4.1-cudnn-devel-u22.04.sif"

module load singularity

# Check if required environment variables are set
if [ -z "$TASK" ]; then
    echo "ERROR: TASK not set"
    exit 1
fi

if [ -z "$CHECKPOINT_DIR" ]; then
    echo "ERROR: CHECKPOINT_DIR not set"
    exit 1
fi

if [ -z "$CHECKPOINT_NAME" ]; then
    echo "ERROR: CHECKPOINT_NAME not set"
    exit 1
fi

if [ -z "$NUM_EXAMPLES" ]; then
    echo "ERROR: NUM_EXAMPLES not set"
    exit 1
fi

singularity exec -e \
--env HF_HOME=/scratch/e1583592/cache \
$image bash << EOF > $CHECKPOINT_DIR/stdout-$CHECKPOINT_NAME-$TASK.$PBS_JOBID.log 2> $CHECKPOINT_DIR/stderr-$CHECKPOINT_NAME-$TASK.$PBS_JOBID.log

source /hpctmp/e1583592/virtualenvs/olmo/bin/activate

echo "Starting evaluating at $(date)"
echo "Running on host: $(hostname)"
echo "GPU info:"
nvidia-smi --query-gpu=name,memory.total,memory.free --format=csv,noheader,nounits || echo "No GPU detected"

python /scratch/e1583592/code/SEA-HELM/seahelm_evaluation.py \
--tasks $TASK \
--output_dir $CHECKPOINT_DIR \
--model_type vllm \
--model_name $CHECKPOINT_DIR \
--model_args "enable_prefix_caching=True,tensor_parallel_size=8" \
--is_base_model \
--num_in_context_examples $NUM_EXAMPLES

EOF